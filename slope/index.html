<!DOCTYPE html>
<html>
<head>
    <title>Slope chart - Visual Vocabulary</title>
    <script src="//d3js.org/d3.v4.js"></script>
    <script src="//d3js.org/d3-selection-multi.v1.min.js"></script>
    <script src="//financial-times.github.io/g-chartframe/build/g-chartframe.js"></script>
    <script src="//ft-interactive.github.io/g-chartcolour/build/g-chartcolour.js"></script>
    <script src="slope.js"></script>

    <link rel="stylesheet" href="https://build.origami.ft.com/v2/bundles/css?modules=o-fonts@^2.2.0" />
    <style type="text/css">
        .web .highlighted-label{
            fill:#000;
            stroke:none;
        }

        svg text{
            font-feature-settings: 'tnum';
            -webkit-font-feature-settings: 'tnum';
            -moz-font-feature-settings: 'tnum';`
        }

    </style>
</head>
<body>

    <h1>Slope chart</h1>
    <p>Good for showing changing data as long as the data can be simplified into 2 points without missing a key part of story</p>
    <hr>
    <figure class="framed web saveable" data-frame="web"><svg></svg></figure>
    <figure class="framed print saveable" data-frame="print"><svg></svg></figure>
    <figure class="framed social saveable" data-frame="social"><svg></svg></figure>
    <figure class="framed video saveable" data-frame="video"><svg></svg></figure>

</body>

<script type="text/javascript">
const frame = {
    web: gChartframe.webFrame
        .margin({left:200,right:200, top:100}),
    print: gChartframe.printFrame,
    social: gChartframe.socialFrame,
    video: gChartframe.videoFrame,
};

d3.selectAll('.framed')
    .each(function(){
        const figure = d3.select(this);
        figure.select('svg')
            .call(frame[figure.node().dataset.frame]);
    });


const dataSorter = (a,b)=> {    //Sort the data so that the labeled items are drawn on top
    if(a.label === 'yes') return 1;
    return -1;
};






d3.csv('data.csv',function(data){

    const valueColumns = ['val1','val2'];    //define the start and end columns
    const valueExtent = extentMulti(data, valueColumns).reverse()
    data.sort(dataSorter);

    //General slope configuration
    const mySlope = slopeChart()
        .colourProperty( 'label' )  //the data property determining the lines colour
        .colourDomain( ['','yes'] ) //the values of theat property corresponding to the colours in the basic chart colour scheme
        .xDomain( valueColumns ) 
        .yDomain( valueExtent )
        .includeLabel( (row)=> (row.label === 'yes') )
        .labelTextStart( (row)=> (row.name + ' ' + row.val1) )
        .labelTextEnd( (row)=> (row.name + ' ' + row.val2) );
    

    //specific slope configuration

    const currentFrame = frame.web;

    mySlope.xRange( [0, currentFrame.dimension().width] )
        .yRange( [0, currentFrame.dimension().height] );

    const myAxes = slopeAxes()
        .xScale( mySlope.xScale() )
        .yScale(Â mySlope.yScale() )
        .startLabel('Start')
        .endLabel('End');

    currentFrame.plot()
        .call( myAxes );

    currentFrame.plot()
        .selectAll( 'g.slope' )
        .data( data )
        .enter()
        .append( 'g' )
            .attr('class','slope')
        .call(mySlope);
});

//a function to work out the extent of values in an array accross multiple properties...
function extentMulti(data, columns){
    const ext = data.reduce((acc, row, index)=>{
        let values = columns.map(key=>row[key])
        let rowExtent = d3.extent(values);
        if(!acc.max){
            acc.max = rowExtent[1];
            acc.min = rowExtent[0];
        }else{
            acc.max = Math.max(acc.max, rowExtent[1]);
            acc.min = Math.min(acc.min, rowExtent[0]);
        }
        return acc;
    },{})
    return [ext.min, ext.max];
}

</script>
</html>