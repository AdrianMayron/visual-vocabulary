<html>
<head>
	<title></title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-geo-projection/0.2.9/d3.geo.projection.min.js"></script>
	<script charset="utf-8" src="http://d3js.org/queue.v1.min.js"></script>
	<style type="text/css">
	*{
		font-family: sans-serif;
	}</style>
</head>
<body>
<h1>World choropleth categorical</h1>
<a href="https://github.com/ft-interactive/graphics-examples/tree/master/world-choropleth-categorical">source</a>
<div class="chart">
</div>

<div class="key">
</div>
</body>
<script type="text/javascript">
	var countryShapes = "https://raw.githubusercontent.com/datasets/geo-boundaries-world-110m/master/countries.geojson";
	var width = 960,
	    height = 500;

	var category = 'same-sex-marriage'
	var categoryFill = {
		'legal':'#4e86b6',
		'legal in certain sub-jurisdictions':'#81d0e6',
		'laws not yet in force':'#ff0000'
	}
	var defaultCategoryFill = '#eee';

	var categoryStroke = {
		'legal':'#fff',
		'legal in certain sub-jurisdictions':'#fff'
	}
	var defaultCategoryStroke = '#none';

	var projection = d3.geo.robinson()
	    .scale( 150 )
	    .translate( [width / 2, height / 2] )
	    .precision( .1 );

	var path = d3.geo.path()
	    .projection(projection);

	var graticule = d3.geo.graticule();

	var svg = d3.select('.chart').append('svg')
		.attr({
			width:width,
			height:height
		});

	svg.append('defs').append('path')
	    .datum({type: 'Sphere'})
		    .attr('id', 'sphere')
		    .attr('d', path);

	//create the background 'sphere'
	svg.append("use")
	    .attr({
	    	'fill':'#FFF',
	    	'stroke':'none'
	    })
	    .attr("xlink:href", "#sphere");

	svg.append("use")
	    .attr({
	    	"stroke":'#eee',
	    	'stroke-width':'2',
	    	'fill':'none'
	    })
	    .attr("xlink:href", "#sphere");

	//create the grid lines
	svg.append('path')
	    .datum(graticule)
	    .attr({
	    	'fill':'none',
	    	'stroke':'#eee'
	    })
	    .attr('d', path);

	//load and draw the countries
	queue()
      .defer(d3.json, countryShapes)
      .defer(d3.csv, 'data.csv')
      .await(drawMap); // function that uses files

	function drawMap(error, world, data) {
		var lookup = makeLookup(data, 'iso_a3');

		svg.selectAll('.nation')
			.data(world.features)
			.enter()
				.append('path')
				.attr({
					d:path,
					fill:function(d){ 
						var id = d.properties.iso_a3;
						var cat = lookup[id][category];
						if(categoryFill[cat] ){
							return categoryFill[cat]; 
						}
						return defaultCategoryFill;
					},
					stroke:function(d){ 
						var id = d.properties.iso_a3;
						var cat = lookup[id][category];
						if(categoryStroke[ cat ] ){
							return categoryStroke[ cat ]; 
						}
						return defaultCategoryStroke;
					}
				});
	};


	function makeLookup(array, property){
    	var lookup = {};
    	array.forEach(function(d){
    		lookup[ d[property] ] = d;
    	});
    	return lookup;
    }
</script>
</html>
