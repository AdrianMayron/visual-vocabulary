<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>TGP Starter kit</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
<article>
    <div class="chart"></div>
</article>
</body>
<script type="text/javascript">
const width = 500;
const height = 500;
const margin = {top:0, left:120, bottom:0, right:0};

	d3.csv('data.csv',function(data){
		console.log(data);
		const valueLabel = 'value %';
		const targetLabel = 'target %';
		const textLabel = 'region';
		const barHeight = 20;

		let barScale = d3.scaleLinear()
			.range([0, width-(margin.left+margin.right)])
			.domain([0, 20]);

		let colourAxis = colourAxisLayout()
			.barHeight(barHeight)
			.domainLabels(['low','medium','high'])
			.colourRange(['#000','#666','#BBB'])
			.linearScale(barScale);

		d3.select('.chart')
			.append('svg')
				.attr('width', width)
				.attr('height', height)
			.selectAll('.bar')
				.data(data)
					.enter()
				.append('g')
					.attr('transform',(d,i)=>'translate('+margin.left+',' + (i*(barHeight*1.2)) + ')')
					.attr('class','bar')
					.each(function(datum){
						let parent = d3.select(this);
						parent.call(colourAxis);
						
						parent.append('text')
							.text(d=>d[textLabel])
							.attr('y', barHeight)
							.attr('text-anchor','end')

						parent.append('rect')
							.attr('width',d => barScale(d[valueLabel]))
							.attr('height', barHeight/2)
							.attr('y', barHeight/4)
							.attr('fill','#F00');

						parent.append('line')
							.attr('x1', d => barScale(d[targetLabel]))
							.attr('x2', d => barScale(d[targetLabel]))
							.attr('y1', 0)
							.attr('y2',Â barHeight)
							.attr('stroke','#0F0');
					});
	});


	function colourAxisLayout(){
		let domainLabels = [];
		let colourRange = [];
		let linearScale = d3.scaleLinear();
		let barHeight = 10;

		function axisLayout(parent){
			let data = parent.datum();
			let colourDomain = domainLabels.map(function(d){
				return Number(data[d]);
			});

			let colourScale = d3.scaleOrdinal()
				.domain(colourDomain)
				.range(colourRange);

			parent.selectAll('.swatch')
				.data(accumulate( colourDomain, linearScale.domain()[1] ))
				.enter()
					.append('rect')
					.attr('width', d => linearScale(d.end - d.start))
					.attr('height', 20)
					.attr('x', d => linearScale(d.start))
					.attr('fill', d=> colourScale(d.start));
		}

		axisLayout.domainLabels = function(a){
			if(!a) return domainLabels;
			domainLabels = a;
			return axisLayout;
		}

		axisLayout.colourRange = function(a){
			if(!a) return colourRange;
			colourRange = a;
			return axisLayout;
		}

		axisLayout.linearScale = function(scale){
			if(!scale) return linearScale;
			linearScale = scale;
			return axisLayout;
		}

		axisLayout.barHeight = function(x){
			if(!x) return barHeight;
			barHeight = x;
			return axisLayout;
		}

		return axisLayout;
	}

	function accumulate(a, endValue){
		return a.reduce(function(accumulator, value, index, array){ 
			let start = value;
			let end = endValue;
			
			if(index < array.length - 1 ){
				end = array[index+1];	
			}
			accumulator.push({ start:start, end:end });
			return accumulator;
		}, []);
	}

</script>
</html>